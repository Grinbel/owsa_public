# ============================================================================
# Kubernetes/k3s Deployment for waldur-site-agent-openstack
# ============================================================================
# This deployment runs waldur-site-agent in event-processing mode for
# real-time synchronization of users between Waldur and OpenStack Keystone.
#
# Architecture:
#   - ONE agent instance per cluster/site
#   - Runs in event-process mode (listens to STOMP events)
#   - Processes ALL offerings configured in the config file
#   - Automatically restarts on failure (Kubernetes handles this)
#
# k8s/k3s Compatibility: 100% compatible with both
# ============================================================================

---
# ============================================================================
# NAMESPACE
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: waldur-agent
  labels:
    name: waldur-agent

---
# ============================================================================
# SERVICE ACCOUNT
# ============================================================================
# Identity for the agent pod
apiVersion: v1
kind: ServiceAccount
metadata:
  name: waldur-agent
  namespace: waldur-agent

---
# ============================================================================
# DEPLOYMENT
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: waldur-site-agent-openstack
  namespace: waldur-agent
  labels:
    app: waldur-site-agent-openstack
    version: "0.1.0"
spec:
  # Only 1 replica - the agent processes all offerings
  replicas: 1

  # Rolling update strategy (zero downtime)
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: waldur-site-agent-openstack

  template:
    metadata:
      labels:
        app: waldur-site-agent-openstack
        version: "0.1.0"

    spec:
      serviceAccountName: waldur-agent

      # Security context for the pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
      - name: agent
        # TODO: Replace with your actual image
        image: your-registry/waldur-site-agent-openstack:0.1.0
        imagePullPolicy: IfNotPresent

        # ====================================================================
        # COMMAND: Start waldur-site-agent in event-process mode
        # ====================================================================
        command:
        - waldur-site-agent
        - run
        - --mode
        - event-process  # Real-time synchronization via STOMP
        - --config
        - /etc/waldur-agent/config.yaml

        # ====================================================================
        # ENVIRONMENT VARIABLES: Secrets for substitution in config file
        # ====================================================================
        env:
        # Waldur API token (substitutes ${WALDUR_API_TOKEN} in config)
        - name: WALDUR_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: waldur-agent-secrets
              key: WALDUR_API_TOKEN

        # OpenStack admin password (substitutes ${OPENSTACK_PASSWORD})
        - name: OPENSTACK_PASSWORD
          valueFrom:
            secretKeyRef:
              name: waldur-agent-secrets
              key: OPENSTACK_PASSWORD

        # STOMP password (substitutes ${STOMP_PASSWORD})
        - name: STOMP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: waldur-agent-secrets
              key: STOMP_PASSWORD

        # Pod metadata (useful for logging)
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

        # ====================================================================
        # RESOURCE LIMITS
        # ====================================================================
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

        # ====================================================================
        # LIVENESS PROBE: Is the agent alive?
        # ====================================================================
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "ps aux | grep -v grep | grep waldur-site-agent"
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        # ====================================================================
        # READINESS PROBE: Is the agent ready to process events?
        # ====================================================================
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "ps aux | grep -v grep | grep waldur-site-agent"
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # ====================================================================
        # VOLUME MOUNTS
        # ====================================================================
        volumeMounts:
        # Config file from ConfigMap
        - name: config
          mountPath: /etc/waldur-agent
          readOnly: true

        # Writable tmp directory (required by agent)
        - name: tmp
          mountPath: /tmp

        # Security context for container
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false  # Agent needs to write logs/temp files

      # ======================================================================
      # VOLUMES
      # ======================================================================
      volumes:
      # ConfigMap containing waldur-site-agent-config.yaml
      - name: config
        configMap:
          name: waldur-agent-config
          items:
          - key: config.yaml
            path: config.yaml

      # Temporary directory
      - name: tmp
        emptyDir: {}

      # Restart policy
      restartPolicy: Always

      # Termination grace period (time to shutdown gracefully)
      terminationGracePeriodSeconds: 30

---
# ============================================================================
# OPTIONAL: CronJob for Backup Sync
# ============================================================================
# This runs membership-sync mode periodically as a backup mechanism.
# Uncomment if you want periodic full synchronization in addition to events.
# ============================================================================
# apiVersion: batch/v1
# kind: CronJob
# metadata:
#   name: waldur-agent-backup-sync
#   namespace: waldur-agent
# spec:
#   # Run every hour
#   schedule: "0 * * * *"
#   jobTemplate:
#     spec:
#       template:
#         spec:
#           serviceAccountName: waldur-agent
#           containers:
#           - name: sync
#             image: your-registry/waldur-site-agent-openstack:0.1.0
#             command:
#             - waldur-site-agent
#             - run
#             - --mode
#             - membership-sync  # Periodic polling mode
#             - --config
#             - /etc/waldur-agent/config.yaml
#             env:
#             - name: WALDUR_API_TOKEN
#               valueFrom:
#                 secretKeyRef:
#                   name: waldur-agent-secrets
#                   key: WALDUR_API_TOKEN
#             - name: OPENSTACK_PASSWORD
#               valueFrom:
#                 secretKeyRef:
#                   name: waldur-agent-secrets
#                   key: OPENSTACK_PASSWORD
#             volumeMounts:
#             - name: config
#               mountPath: /etc/waldur-agent
#               readOnly: true
#           volumes:
#           - name: config
#             configMap:
#               name: waldur-agent-config
#           restartPolicy: OnFailure

# ============================================================================
# Deployment Instructions
# ============================================================================
#
# 1. Create namespace:
#    kubectl create namespace waldur-agent
#
# 2. Create secrets:
#    kubectl create secret generic waldur-agent-secrets \
#      --from-literal=WALDUR_API_TOKEN='your-token' \
#      --from-literal=OPENSTACK_PASSWORD='your-password' \
#      --from-literal=STOMP_PASSWORD='your-stomp-password' \
#      -n waldur-agent
#
# 3. Apply ConfigMap (edit it first with your values!):
#    kubectl apply -f kubernetes/configmap.yaml
#
# 4. Apply Deployment:
#    kubectl apply -f kubernetes/deployment.yaml
#
# 5. Check status:
#    kubectl get pods -n waldur-agent
#    kubectl logs -f deployment/waldur-site-agent-openstack -n waldur-agent
#
# 6. Update configuration:
#    kubectl edit configmap waldur-agent-config -n waldur-agent
#    kubectl rollout restart deployment waldur-site-agent-openstack -n waldur-agent
#
# ============================================================================

# ============================================================================
# k8s/k3s Compatibility Notes
# ============================================================================
#
# This deployment works identically on:
# - Standard Kubernetes
# - k3s (lightweight Kubernetes)
# - k0s, microk8s, etc.
#
# k3s specific notes:
# - Uses same kubectl commands
# - Storage class: local-path (default in k3s)
# - No special configuration needed
#
# ============================================================================
