# ============================================================================
# ConfigMap: waldur-site-agent Configuration
# ============================================================================
# This ConfigMap contains the waldur-site-agent configuration file.
# The agent reads this file and processes all configured offerings.
#
# IMPORTANT: Sensitive data (passwords, tokens) should be in Secrets,
# not in this ConfigMap. Use ${ENV_VAR} syntax to reference secrets.
#
# k8s/k3s Compatibility: 100% compatible with both
# ============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: waldur-agent-config
  namespace: waldur-agent
  labels:
    app: waldur-site-agent-openstack
    component: configuration
data:
  # --------------------------------------------------------------------------
  # waldur-site-agent-config.yaml
  # --------------------------------------------------------------------------
  # This is the main configuration file read by the agent.
  # It will be mounted at /etc/waldur-agent/config.yaml in the pod.
  # --------------------------------------------------------------------------
  config.yaml: |
    # Global settings
    timezone: "UTC"

    # Offerings configuration
    offerings:
      - # Waldur API connection
        waldur_api_url: "https://waldur.example.com/api"
        waldur_api_token: "${WALDUR_API_TOKEN}"
        waldur_offering_uuid: "your-openstack-offering-uuid-here"

        # Backend configuration
        backend_type: "openstack"

        backend_settings:
          # OpenStack Keystone authentication
          auth_url: "https://keystone.example.com:5000/v3"
          username: "admin"
          password: "${OPENSTACK_PASSWORD}"
          project_name: "admin"
          domain_name: "Default"
          region_name: "RegionOne"
          interface: "public"
          verify_ssl: true

          # User management
          default_role: "_member_"
          create_users_if_not_exist: true
          sync_user_emails: true
          user_enabled_by_default: true

          # Retry settings
          max_retry_attempts: 3
          retry_delay_seconds: 5

        # Backend selection per function
        order_processing_backend: "openstack"
        membership_sync_backend: "openstack"
        reporting_backend: "openstack"

        # Resource components (for reporting)
        backend_components:
          vcpu:
            accounting_type: "usage"
            measured_unit: "hours"
          ram:
            accounting_type: "usage"
            measured_unit: "GB"

        # STOMP event processing configuration
        stomp_enabled: true
        stomp_host: "waldur.example.com"
        stomp_port: 61613
        stomp_use_tls: true
        stomp_username: "agent"
        stomp_password: "${STOMP_PASSWORD}"
        stomp_vhost: "/"

        # Additional options
        resource_import_enabled: false
        waldur_api_verify_ssl: true

# ============================================================================
# How to Use This ConfigMap
# ============================================================================
#
# 1. Edit the config.yaml content above with your actual values
#    - Replace waldur.example.com with your Waldur hostname
#    - Replace keystone.example.com with your OpenStack Keystone URL
#    - Replace "your-openstack-offering-uuid-here" with actual UUID
#
# 2. Apply to cluster:
#    kubectl apply -f kubernetes/configmap.yaml
#
# 3. The Deployment will mount this at /etc/waldur-agent/config.yaml
#
# 4. Environment variables from Secrets are substituted automatically:
#    ${WALDUR_API_TOKEN} → value from Secret waldur-credentials
#    ${OPENSTACK_PASSWORD} → value from Secret openstack-credentials
#    ${STOMP_PASSWORD} → value from Secret waldur-credentials
#
# ============================================================================

# ============================================================================
# k8s/k3s Compatibility Notes
# ============================================================================
# ConfigMaps work identically in Kubernetes and k3s.
#
# To update configuration:
#   1. Edit this file
#   2. kubectl apply -f kubernetes/configmap.yaml
#   3. Restart the agent:
#      kubectl rollout restart deployment waldur-site-agent-openstack -n waldur-agent
#
# To view current configuration:
#   kubectl get configmap waldur-agent-config -n waldur-agent -o yaml
#
# ============================================================================
